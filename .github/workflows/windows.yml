name: Build & Release kcat (Windows)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build-and-release:
    runs-on: windows-2022
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: NuGet Restore
        run: nuget restore win32\kcat.sln

      # ---------------------------
      # Build x64
      # ---------------------------
      - name: Build kcat x64 Release
        run: msbuild win32\kcat.sln /p:Configuration=Release /p:Platform=x64

      - name: Copy librdkafka DLLs (x64)
        shell: pwsh
        run: |
          $pkg = Get-ChildItem -Recurse -Path "win32/packages" -Filter "librdkafka.redist*" | Select-Object -First 1
          if (-not $pkg) { throw "librdkafka.redist package not found" }
          Copy-Item "$($pkg.FullName)\runtimes/win-x64/native/*.dll" "win32/x64/Release/" -Force

      - name: Package x64 runtime files
        shell: pwsh
        run: |
          $src = "win32/x64/Release"
          $out = "$env:GITHUB_WORKSPACE/kcat-windows-x64"
          New-Item -ItemType Directory $out -Force | Out-Null

          $keep = @(
            "kcat.exe",
            "librdkafka.dll",
            "librdkafkacpp.dll",
            "libcrypto*.dll",
            "libssl*.dll",
            "zlib1.dll",
            "zstd.dll",
            "msvcp*.dll",
            "vcruntime*.dll"
          )

          foreach ($pattern in $keep) {
            Get-ChildItem "$src/$pattern" -ErrorAction SilentlyContinue | Copy-Item -Destination $out -Force
          }

          Compress-Archive -Path "$out/*" -DestinationPath "$env:GITHUB_WORKSPACE/kcat-windows-x64.zip" -Force

      # ---------------------------
      # Build x86
      # ---------------------------
      - name: Build kcat x86 Release
        run: msbuild win32\kcat.sln /p:Configuration=Release /p:Platform=x86

      - name: Copy librdkafka DLLs (x86)
        shell: pwsh
        run: |
          $pkg = Get-ChildItem -Recurse -Path "win32/packages" -Filter "librdkafka.redist*" | Select-Object -First 1
          if (-not $pkg) { throw "librdkafka.redist package not found" }
          Copy-Item "$($pkg.FullName)\runtimes/win-x86/native/*.dll" "win32/Release/" -Force

      - name: Package x86 runtime files
        shell: pwsh
        run: |
          $src = "win32/Release"
          $out = "$env:GITHUB_WORKSPACE/kcat-windows-x86"
          New-Item -ItemType Directory $out -Force | Out-Null

          $keep = @(
            "kcat.exe",
            "librdkafka.dll",
            "librdkafkacpp.dll",
            "libcrypto*.dll",
            "libssl*.dll",
            "zlib1.dll",
            "zstd.dll",
            "msvcp*.dll",
            "vcruntime*.dll"
          )

          foreach ($pattern in $keep) {
            Get-ChildItem "$src/$pattern" -ErrorAction SilentlyContinue | Copy-Item -Destination $out -Force
          }

          Compress-Archive -Path "$out/*" -DestinationPath "$env:GITHUB_WORKSPACE/kcat-windows-x86.zip" -Force

      # ---------------------------
      # Optional: Upload runtime files for CI inspection
      # ---------------------------
      - name: Upload x64 runtime files for CI
        uses: actions/upload-artifact@v4
        with:
          name: kcat-windows-x64-files
          path: win32/x64/Release/*

      - name: Upload x86 runtime files for CI
        uses: actions/upload-artifact@v4
        with:
          name: kcat-windows-x86-files
          path: win32/Release/*

      # ---------------------------
      # Release: Attach ZIPs to GitHub Release
      # ---------------------------
      - name: Upload x64 ZIP to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: kcat-windows-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload x86 ZIP to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: kcat-windows-x86.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

